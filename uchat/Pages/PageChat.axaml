<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:uchat"
             x:Class="uchat.PageChat">
    
    <UserControl.Resources>
        <local:BoolToAlignment x:Key="BoolToAlignment"/>
        <local:BoolToBrush x:Key="BoolToBrush"/>
        <local:InverseBoolConverter x:Key="InverseBoolConverter"/> 
        <local:GroupAvatarVisibilityConverter x:Key="GroupAvatarVisibilityConverter"/>
        <local:SenderToColorConverter x:Key="SenderToColorConverter"/>
        <local:GroupSenderVisibilityConverter x:Key="GroupSenderVisibilityConverter"/> 
        <local:ShutdownTextConverter x:Key="ShutdownTextConverter"/>
        <local:PinnedToIconConverter x:Key="PinnedToIconConverter"/>
        <local:PinMenuTextConverter x:Key="PinMenuTextConverter"/>
        <local:TailLeftVisibilityConverter x:Key="TailLeftVisibilityConverter"/>
        <local:TailRightVisibilityConverter x:Key="TailRightVisibilityConverter"/>
        <local:TailMarginConverter x:Key="TailMarginConverter"/>
        <local:SentTimeConverter x:Key="SentTimeConverter"/>
        <local:BoolToMarginConverter x:Key="BoolToMarginConverter"/>
        <local:DynamicMaxWidthConverter x:Key="MaxWidthConv"/>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
        <ColumnDefinition Width="50"/>
        <ColumnDefinition Width="1*" MinWidth="260" MaxWidth="400"/>
        <ColumnDefinition Width="2*"/>
    </Grid.ColumnDefinitions>
        
        <Grid Grid.Column="0" Background="{DynamicResource LeftSideBarBackgroundBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <Button Grid.Row="0" Classes="nohover" HorizontalAlignment="Center" Margin="3,15,0,0" Cursor="Hand">
                <Grid>
                    <Image x:Name="ExitLight" Source="avares://uchat/Resources/images/ExitLight.png" Height="40" Width="40"/>
                    <Image x:Name="ExitDark" Source="avares://uchat/Resources/images/ExitDark.png" Height="40" Width="40"/>
                </Grid>
            </Button>
            
            <Button Grid.Row="2" Classes="nohover" HorizontalAlignment="Center" Cursor="Hand" Click="OpenSingleChat_Click">
                <Grid>
                    <Image x:Name="SingleChatLight" Source="avares://uchat/Resources/images/SingleChatLight.png" Height="40" Width="40"/>
                    <Image x:Name="SingleChatDark" Source="avares://uchat/Resources/images/SingleChatDark.png" Height="40" Width="40"/>
                </Grid>
            </Button>
            
            <Button Grid.Row="3" Classes="nohover" HorizontalAlignment="Center" Margin="0,20,0,30" Cursor="Hand" Click="OpenGroupChat_Click">
                <Grid>
                    <Image x:Name="GroupChatLight" Source="avares://uchat/Resources/images/GroupChatLight.png" Height="40" Width="40"/>
                    <Image x:Name="GroupChatDark" Source="avares://uchat/Resources/images/GroupChatDark.png" Height="40" Width="40"/>
                </Grid>
            </Button>
            
            <Button Grid.Row="4" Classes="nohover" HorizontalAlignment="Center" Margin="0,0,0,15" Cursor="Hand" Click="SwitchTheme_Click">
                <Grid>
                    <Image x:Name="ModeLight" Source="avares://uchat/Resources/images/ModeLight.png" Height="40" Width="40"/>
                    <Image x:Name="ModeDark" Source="avares://uchat/Resources/images/ModeDark.png" Height="40" Width="40"/>
                </Grid>
            </Button>
        </Grid>
        
        <Grid Grid.Column="1" Background="{DynamicResource ChatListBackgroundBrush}" RowDefinitions="60,Auto,*">
            <Border Grid.Row="0" Background="{DynamicResource ProfileBackgroundBrush}" Padding="10">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="10">
                    <Ellipse Width="45" Height="45" Fill="Gray"/>
                    <StackPanel Orientation="Vertical" VerticalAlignment="Center" Spacing="5">
                        <TextBlock Text="{Binding CurrentUserName}" FontSize="17" FontWeight="Bold" Foreground="White"/>
                        <TextBlock Text="{Binding CurrentUserUsername}" 
                                   FontSize="14" Foreground="rgba(255,255,255,0.6)"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Grid.Row="1" Padding="10">
                 <StackPanel Orientation="Horizontal" Spacing="5">
                    <Grid Width="240">
                        <TextBox x:Name="SearchTextBox" FontSize="16" Watermark="Search in chats..." Classes="staticBg" 
                               Background="#9183B0" Foreground="White" TextChanged = "SearchTextBox_OnTextChanged" Padding="10,0,30,0" 
                               GotFocus="SearchTextBox_GotFocus" LostFocus="SearchTextBox_LostFocus"/>
                        <Button x:Name="ClearSearchButton" Content="✖" FontSize="13" Width="20" Height="20" 
                                HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0" 
                                IsVisible="False" Background="Transparent" Click="ClearSearchButton_Click"
                                FontWeight="Bold" Cursor="Hand" Classes = "nohover"
                                PointerPressed="ClearSearchButton_OnPointerPressed"/>
                    </Grid>
                </StackPanel> 
            </Border>
            
            <ListBox Grid.Row="2" x:Name="ChatList" Background="{DynamicResource ChatListBackgroundBrush}" SelectionChanged="ChatList_SelectionChanged">
                <ListBox.Styles>
                    <Style Selector="ListBoxItem:selected">
                        <Setter Property="Background" Value="{DynamicResource SelectedChatBackgroundBrush}"/>
                    </Style>
                    <Style Selector="ListBoxItem">
                        <Setter Property="Background" Value="Transparent"/>
                    </Style>
                </ListBox.Styles>
                
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="45,*" IsHitTestVisible="True" Background="Transparent"
                              PointerPressed="ChatItem_OnPointerPressed" ContextRequested="ChatItem_ContextRequested"
                              Height="60">
                            
                            <Grid.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="{Binding IsPinned, Converter={StaticResource PinMenuTextConverter}}" 
                                              Click="TogglePinChat_Click"/>
                                </ContextMenu>
                            </Grid.ContextMenu>
                            
                            <Ellipse Grid.Column="0" Width="40" Height="40" Fill="Gray" VerticalAlignment="Center"/>
                            
                            <StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Center" Margin="5,0">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="{Binding Name}" FontWeight="Bold" Foreground="White" TextWrapping="NoWrap"
                                               TextTrimming="CharacterEllipsis" Margin="0,0,5,0"/>
                                    
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding LastMessageTime, Converter={StaticResource SentTimeConverter}}" FontSize="12" 
                                                           Foreground="LightGray" HorizontalAlignment="Right"  VerticalAlignment="Center"/>
                                    
                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding LastMessage}" FontSize="14" Margin="0,5,0,0"
                                               Foreground="rgba(255,255,255,0.7)" TextTrimming="CharacterEllipsis"/>
                                
                                    <Image Grid.Row="1" Grid.Column="1" Source="{Binding IsPinned, Converter={StaticResource PinnedToIconConverter}}"
                                           Width="13" Height="13" VerticalAlignment="Bottom" HorizontalAlignment="Right"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Grid>
        
        <Grid Grid.Column="2" Background="{DynamicResource MainBackgroundBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="60"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="{DynamicResource ChatListBackgroundBrush}" Padding="10">
                <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
                    <Ellipse Grid.Column="0" x:Name="ChatAvatar" Width="40" Height="40" Fill="Gray" VerticalAlignment="Center" 
                                            IsVisible="False"/>
                    <StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Center" Spacing="2" Margin="10,0,0,0">
                        <TextBlock x:Name="ChatHeader" FontSize="20" FontWeight="Bold" Foreground="White" />
                        <TextBlock x:Name="ChatUsernameTextBlock" FontSize="15" IsVisible="False" Foreground="White" />
                    </StackPanel>
                    <Button Grid.Column="2" Width="30" Height="30" IsVisible="{Binding ShowToggleMembersButton}"
                                  Cursor="Hand" Classes="nohover" Click="ToggleMembersButton_Click" Margin="0,0,10,0">
                        <Grid>
                            <Image x:Name="UpImage" Source="avares://uchat/Resources/images/up.png"/>
                            <Image x:Name="DownImage" Source="avares://uchat/Resources/images/down.png"/>
                        </Grid>
                    </Button>
                </Grid>
            </Border>
            
            <Grid Grid.Row="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,5,0" ZIndex="0">
                    <ItemsControl x:Name="MessagesPanel" ItemsSource="{Binding SelectedChatMessages}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="{Binding IsMine, 
                                            Converter={StaticResource BoolToAlignment}}" 
                                            Margin="{Binding IsMine, Converter={StaticResource BoolToMarginConverter}}"
                                            VerticalAlignment="Bottom">
                                    <Ellipse Width="35" Height="35" Margin="0,0,5,0" VerticalAlignment="Bottom" >
                                        <Ellipse.Fill>
                                            <Binding Path="Sender" Converter="{StaticResource SenderToColorConverter}" />
                                        </Ellipse.Fill>
                                        <Ellipse.IsVisible>
                                            <MultiBinding Converter="{StaticResource GroupAvatarVisibilityConverter}">
                                                <Binding Path="IsMine"/>
                                                <Binding Path="IsGroup"/>
                                                <Binding Path="ShowAvatar"/>
                                            </MultiBinding>
                                        </Ellipse.IsVisible>
                                    </Ellipse>
                                    
                                    <StackPanel>
                                        <TextBlock Text="{Binding Sender}" Margin="10,0,0,2">
                                            <TextBlock.IsVisible>
                                                <MultiBinding Converter="{StaticResource GroupSenderVisibilityConverter}">
                                                    <Binding Path="IsMine"/>
                                                    <Binding Path="IsGroup"/>
                                                </MultiBinding>
                                            </TextBlock.IsVisible>
                                        </TextBlock>
                                        
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <Polygon Grid.Column="0" Width="10" Height="10" Points="10,0 -5,7 15,10" ZIndex="0" 
                                                     Fill="{Binding IsMine, Converter={StaticResource BoolToBrush}}"
                                                     VerticalAlignment="Bottom" Margin="0,0,-4,0">
                                                <Polygon.IsVisible>
                                                    <MultiBinding Converter="{StaticResource TailLeftVisibilityConverter}">
                                                        <Binding Path="ShowTail"/>
                                                        <Binding Path="IsMine"/>
                                                    </MultiBinding>
                                                </Polygon.IsVisible>
                                                <Polygon.RenderTransform>
                                                <TranslateTransform Y="-1"/>
                                            </Polygon.RenderTransform>
                                            </Polygon>

                                            <Border Grid.Column="1" VerticalAlignment="Bottom" Background="{Binding IsMine, Converter={StaticResource BoolToBrush}}" 
                                                    CornerRadius="10" Padding="10,5" ZIndex="1">
                                                <Border.Margin>
                                                    <MultiBinding Converter="{StaticResource TailMarginConverter}">
                                                        <Binding Path="ShowTail"/>
                                                        <Binding Path="IsMine"/>
                                                    </MultiBinding>
                                                </Border.Margin>
                                                <StackPanel Orientation="Vertical" Spacing="2">
                                                    <StackPanel Orientation="Horizontal" Spacing="5">
                                                        <Image Source="avares://uchat/Resources/images/DeletedMsg.png" Width="16" Height="16"
                                                               IsVisible="{Binding IsDeleted}"/>
                                                        <Grid MaxWidth="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Window}}, 
                                                            Path=Bounds.Width, Converter={StaticResource MaxWidthConv}}">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Grid.Column="0" Text="{Binding DisplayText}" TextWrapping="Wrap" LineHeight="20" Foreground="White" />
                                                            <TextBlock Grid.Column="1" Text="edited" FontSize="10" VerticalAlignment="Bottom" Foreground="LightGray" Margin="5,0,0,0" IsVisible="{Binding ShowEdited}"/>
                                                            <TextBlock Grid.Column="2" Text="{Binding SentTime, StringFormat='HH:mm'}" FontSize="10" Foreground="LightGray"
                                                                       VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                                                        </Grid>
                                                    </StackPanel>
                                                </StackPanel>

                                                <Border.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="Copy" Click="CopyMessage_Click"/>
                                                        <MenuItem Header="Edit" Click="EditMessage_Click" IsEnabled="{Binding IsDeleted, Converter={StaticResource InverseBoolConverter}}" IsVisible="{Binding IsMine}"/>
                                                        <MenuItem Header="Delete" Click="DeleteMessageForAll_Click"/>
                                                    </ContextMenu>
                                                </Border.ContextMenu>
                                            </Border>
                                            
                                            <Polygon Grid.Column="2" Width="10" Height="10" Points="-10,-5 14,7 -15,11" Margin="-4,0,0,0" 
                                                     ZIndex="0" Fill="{Binding IsMine, Converter={StaticResource BoolToBrush}}"
                                                     VerticalAlignment="Bottom">
                                                <Polygon.IsVisible>
                                                    <MultiBinding Converter="{StaticResource TailRightVisibilityConverter}">
                                                        <Binding Path="ShowTail"/>
                                                        <Binding Path="IsMine"/>
                                                    </MultiBinding>
                                                </Polygon.IsVisible>
                                                <Polygon.RenderTransform>
                                                <TranslateTransform Y="-1"/>
                                            </Polygon.RenderTransform>
                                            </Polygon>
                                        </Grid>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
                
                <Border x:Name="GroupMembersPanel" Background="#453359" Padding="8" IsVisible="False" ZIndex="1" 
                        VerticalAlignment="Top" Width="300" HorizontalAlignment="Right" MaxHeight="300">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="Group members" FontSize="16" FontWeight="Bold" Margin="5,0,0,10" Foreground="White"/>
                            <ItemsControl x:Name="GroupMembersList">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="40,*" Margin="4">
                                            <Ellipse Grid.Column="0" Width="35" Height="35" Fill="Gray" VerticalAlignment="Center" />
                                            <StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Center" Margin="10,0">
                                                <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="White" Margin="0,0,0,3" />
                                                <TextBlock Text="{Binding Username}" FontSize="14" Foreground="White"/>
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
            
            <Grid x:Name="MessageInputPanel" Grid.Row="2" IsVisible="False" Margin="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBox x:Name="MessageTextBox" FontSize="18" Watermark="Type a message..." Padding="10,5,60,5" Classes="staticBg" Background="White"
                         TextWrapping="Wrap" Text="{Binding ChatList.SelectedItem.Draft, Mode=TwoWay}" AcceptsReturn="False"
                         VerticalContentAlignment="Center" MinHeight="50" MaxHeight="120" TextChanged="MessageTextBox_OnTextChanged" KeyDown="MessageTextBox_SendWithEnter"/>
                <Image Source="avares://uchat/Resources/images/send.png"
                       Width="35" Height="35"
                       HorizontalAlignment="Right"
                       VerticalAlignment="Center"
                       Margin="0,0,10,0"
                       PointerPressed="SendMessage_Click"/>
            </Grid>
            
            <Border x:Name="SingleChatOverlay" Background="{DynamicResource MainBackgroundBrush}" Grid.Row="1" Grid.RowSpan="2" IsVisible="False">
                <Grid Margin="30">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="23"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid Grid.Row="0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="50"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" x:Name="SearchUserBox" Watermark="Search for user..." FontSize="18" Classes="staticBg" Padding="10,0,30,0"
                                     HorizontalAlignment="Stretch" Background="#9183B0" Foreground="White" TextChanged="SearchUserBox_OnTextChanged"
                                     GotFocus="SearchUserBox_GotFocus" LostFocus="SearchUserBox_LostFocus"/>
                            <Button Grid.Column="0" x:Name="ClearSearchUserBoxButton" Content="✖" FontSize="13" Width="20" Height="20" 
                                    HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0" 
                                    IsVisible="False" Background="Transparent" FontWeight="Bold" Cursor="Hand" Classes="nohover"
                                    Click="ClearSearchUserBoxButton_Click"/>
                            <Button Grid.Column="1" x:Name="SearchButton" FontSize="18" Margin="5,0,0,0" Foreground="White" Classes="nohover"
                                    HorizontalAlignment="Right" BorderThickness="0" Click="SearchButton_Click">
                                <Image Source="avares://uchat/Resources/images/search.png"
                                       Width="30" Height="30" />
                            </Button>
                        </Grid>
                    </Grid>
                    
                    <TextBlock Grid.Row="1" x:Name="SearchErrorText" Text="" FontSize="14" Foreground="Red" Margin="10,7,0,0" IsVisible="False"/>
                    
                    <Border Grid.Row="2" x:Name="SearchResultBorder" Background="{DynamicResource ChatListBackgroundBrush}" CornerRadius="10" Padding="10" Margin="0,10,0,0" IsVisible="False">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="10">
                            <Ellipse Width="45" Height="45" Fill="Gray"/>
                            <StackPanel Orientation="Vertical" VerticalAlignment="Center" Spacing="5">
                                <TextBlock x:Name="ResultUserName" Text="" FontSize="17" FontWeight="Bold" Foreground="White"/>
                                <TextBlock x:Name="ResultUserUsername" Text="" FontSize="14" Foreground="rgba(255,255,255,0.6)"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                   
                    <Button Grid.Row="4" Content="Start chat" x:Name="StartChatButton" Classes="submitBtn" Width="200" 
                            HorizontalAlignment="Center" FontSize="18" FontWeight="Bold" Click="StartChatButton_Click"/>
                </Grid>
            </Border>
            
            <Border x:Name="GroupChatOverlay" Background="{DynamicResource MainBackgroundBrush}" Grid.Row="1" Grid.RowSpan="2" IsVisible="False">
                <Grid Margin="30,20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="23"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="5"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="20"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <Grid Grid.Row="0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="50"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" x:Name="GroupSearchBox" Watermark="Search for user..." FontSize="18" Padding="10,0,30,0"
                                     HorizontalAlignment="Stretch" Background="#9183B0" Foreground="White" Classes="staticBg"
                                     TextChanged="GroupSearchBox_OnTextChanged" GotFocus="GroupSearchBox_GotFocus" 
                                     LostFocus="GroupSearchBox_LostFocus"/>
                            <Button Grid.Column="0" x:Name="ClearGroupSearchBoxButton" Content="✖" FontSize="13" Width="20" Height="20" 
                                    HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0" 
                                    IsVisible="False" Background="Transparent" FontWeight="Bold" Cursor="Hand" Classes="nohover"
                                    Click="ClearGroupSearchBoxButton_Click"/>
                            <Button Grid.Column="1" x:Name="GroupSearchButton" FontSize="18" Margin="5,0,0,0" Foreground="White"
                                    HorizontalAlignment="Right" Classes="nohover" BorderThickness="0" Click="GroupSearchButton_Click">
                                <Image Source="avares://uchat/Resources/images/search.png"
                                       Width="30" Height="30" />
                            </Button>
                        </Grid>
                    </Grid>
                    
                    <TextBlock Grid.Row="1" x:Name="GroupSearchErrorText" Text="" FontSize="14" Foreground="Red" Margin="10,7,0,0" IsVisible="False"/>
                    
                    <Border Grid.Row="2" x:Name="GroupSearchResultBorder"
                            Background="{DynamicResource ChatListBackgroundBrush}" CornerRadius="10" Padding="10" Margin="0,10,0,0"
                            VerticalAlignment="Top" IsVisible="False">
                        <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
                            <Ellipse Grid.Column="0" Width="40" Height="40" Fill="Gray" Margin="0,0,10,0"/>
                            <Grid Grid.Column="1">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="18"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0" x:Name="GroupResultName" FontSize="15" Foreground="White"/>
                                <TextBlock Grid.Row="1" x:Name="GroupResultUsername" VerticalAlignment="Center" FontSize="13" Foreground="LightGray"/>
                            </Grid>
                            <Button Grid.Column="2" x:Name="AddMemberButton" Classes="nohover" VerticalAlignment="Center" Margin="5,0,0,0" Cursor="Hand" Click="AddMemberButton_Click">
                                <Image Source="avares://uchat/Resources/images/add1.png" Width="28" Height="28"/>
                            </Button>
                        </Grid>
                    </Border>
                    
                    <ScrollViewer Grid.Row="4" VerticalScrollBarVisibility="Auto">
                        <ListBox x:Name="SelectedMembersList" ItemsSource="{Binding SelectedGroupMembers}" Height="280"
                                 Background="{DynamicResource ChatListBackgroundBrush}" CornerRadius="10" BorderBrush="Transparent" Margin="0,15,0,15">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
                                        <Ellipse Grid.Column="0" Width="40" Height="40" Fill="Gray" Margin="0,0,10,0"/>
                                        <Grid Grid.Column="1">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="18"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            <TextBlock Text="{Binding Name}" Grid.Row="0" FontSize="15" Foreground="White"/>
                                            <TextBlock Text="{Binding Username}" Grid.Row="1" VerticalAlignment="Center" FontSize="13" Foreground="LightGray"/>
                                        </Grid>
                                        <Button Grid.Column="2" x:Name="RemoveMemberButton" Classes="nohover" VerticalAlignment="Center" Margin="5,0,0,0" Cursor="Hand" Click="RemoveMemberButton_Click">
                                            <Image Source="avares://uchat/Resources/images/removee.png" Width="23" Height="23"/>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                    <Grid Grid.Row ="5">
                    <TextBox x:Name="GroupNameBox" Watermark="Enter chat name" FontSize="18" Padding="10,0,30,0" Classes="staticBg"
                             HorizontalAlignment="Stretch" Background="#9183B0" Foreground="White" TextChanged="GroupNameBox_OnTextChanged"/>
                    <Button x:Name="ClearGroupNameBoxButton" Content="✖" FontSize="13" Width="20" Height="20" 
                            HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0" 
                            IsVisible="False" Background="Transparent" FontWeight="Bold" Cursor="Hand" Classes="nohover"
                            Click="ClearGroupNameBoxButton_Click" GotFocus="GroupNameBox_GotFocus" 
                            LostFocus="GroupNameBox_LostFocus"/>
                    </Grid>
                    <TextBlock Grid.Row="6" x:Name="GroupNameErrorText" Text="Name cannot be empty" FontSize="14" Foreground="Red" Margin="10,2,0,0" IsVisible="False"/>
                    
                    <Button Grid.Row="7" Content="Create group chat" x:Name="CreateGroupButton" Classes="submitBtn" Width="200" VerticalAlignment="Bottom"
                            HorizontalAlignment="Center" FontSize="18" FontWeight="Bold" Click="CreateGroupChat_Click"/>
                </Grid>
            </Border>
        </Grid>
        </Grid>
        
        <Border Background="#80000000" IsVisible="{Binding IsReconnecting}" 
                HorizontalAlignment="Stretch" VerticalAlignment="Stretch" >
            <Border Width="400" Height="150" BorderBrush="MediumPurple" BorderThickness="3" Padding="20" Background="White">
                <StackPanel Spacing="30" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="{Binding NeedToShutdown,
                               Converter={StaticResource ShutdownTextConverter}}"
                               HorizontalAlignment="Center" FontSize="20"/>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>