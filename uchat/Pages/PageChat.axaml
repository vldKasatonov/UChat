<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:uchat"
             x:Class="uchat.PageChat">
    
    <UserControl.Resources>
        <local:BoolToAlignment x:Key="BoolToAlignment"/>
        <local:BoolToBrush x:Key="BoolToBrush"/>
        <local:InverseBoolConverter x:Key="InverseBoolConverter"/> 
        <local:GroupAvatarVisibilityConverter x:Key="GroupAvatarVisibilityConverter"/>
        <local:SenderToColorConverter x:Key="SenderToColorConverter"/>
        <local:GroupSenderVisibilityConverter x:Key="GroupSenderVisibilityConverter"/> 
    </UserControl.Resources>

    <Grid ColumnDefinitions="50,230,*">
        
        <Grid Grid.Column="0" Background="#1C1729">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <Button Grid.Row="0" Classes="nohover" HorizontalAlignment="Center" Margin="3,15,0,0" Cursor="Hand">
                <Image Source="avares://uchat/Resources/images/exit.png" Width="30" Height="30"/>
            </Button>
            
            <Button Grid.Row="2" Classes="nohover" HorizontalAlignment="Center" Cursor="Hand" Click="OpenSingleChat_Click">
                <Image Source="avares://uchat/Resources/images/single_chat.png" Width="40" Height="40"/>
            </Button>
            
            <Button Grid.Row="3" Classes="nohover" HorizontalAlignment="Center" Margin="0,20,0,30" Cursor="Hand" Click="OpenGroupChat_Click">
                <Image Source="avares://uchat/Resources/images/group_chat.png" Width="35" Height="35"/>
            </Button>
            
            <Button Grid.Row="4" Classes="nohover" HorizontalAlignment="Center" Margin="0,0,0,15" Cursor="Hand">
                <Image Source="avares://uchat/Resources/images/mode.png" Width="35" Height="35"/>
            </Button>
        </Grid>
        
        <Grid Grid.Column="1" Background="#453359" RowDefinitions="Auto,Auto,*">
            
            <Border Grid.Row="0" Background="#3A2C4A" Padding="10">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="10">
                    <Ellipse Width="45" Height="45" Fill="Gray"/>
                    <StackPanel Orientation="Vertical" VerticalAlignment="Center" Spacing="5">
                        <TextBlock Text="{Binding CurrentUserName}" FontSize="17" FontWeight="Bold" Foreground="White"/>
                        <TextBlock Text="{Binding CurrentUserUsername}" 
                                   FontSize="14" Foreground="rgba(255,255,255,0.6)"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border Grid.Row="1" Padding="10">
                 <StackPanel Orientation="Horizontal" Spacing="5">
                    <Grid Width = "210">
                        <TextBox x:Name="SearchTextBox" Width="210" FontSize="15" Watermark="Search in chat..." 
                               Background="#9183B0" Foreground="White" TextChanged = "SearchTextBox_OnTextChanged"
                               CaretBrush = "White" Padding="10,0,30,0" 
                               GotFocus="SearchTextBox_GotFocus" LostFocus="SearchTextBox_LostFocus"/>
                        <Button x:Name="ClearSearchButton" Content="âœ–" FontSize="13" Width="20" Height="20" 
                                HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0" 
                                IsVisible="False" Background="Transparent" Click="ClearSearchButton_Click"
                                FontWeight="Bold" Cursor="Hand" Classes = "nohover"
                                PointerPressed="ClearSearchButton_OnPointerPressed"/>
                    </Grid>
                </StackPanel> 
            </Border>
            
            <ListBox Grid.Row="2" x:Name="ChatList" Background="#453359" SelectionChanged="ChatList_SelectionChanged">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid ColumnDefinitions="45,*" IsHitTestVisible="True" Background="Transparent"
                              PointerPressed="ChatItem_OnPointerPressed">
                            <Ellipse Grid.Column="0" Width="40" Height="40" Fill="Gray" VerticalAlignment="Center"/>
                            <StackPanel Grid.Column="1" Orientation="Vertical" VerticalAlignment="Center" Margin="5,0">
                                <TextBlock Text="{Binding Name}" />
                                <TextBlock Text="{Binding LastMessage}" FontSize="14" Margin="0,5,0,0"
                                           Foreground="rgba(255,255,255,0.7)" TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Grid>
        
        <Grid Grid.Column="2" Background="White">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="#5F4D74" Padding="10">
                <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                    <Ellipse x:Name="ChatAvatar" Width="40" Height="40" Fill="Gray" VerticalAlignment="Center" 
                             IsVisible="False"/>
                    <StackPanel Orientation="Vertical" Spacing="5">
                        <TextBlock x:Name="ChatHeader" FontSize="20" FontWeight="Bold" Foreground="White" />
                        <TextBlock x:Name="ChatUsernameTextBlock" FontSize="15" IsVisible="False" Foreground="White" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="0,0,5,0">
                <ItemsControl x:Name="MessagesPanel" ItemsSource="{Binding SelectedChatMessages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="{Binding IsMine, 
                                    Converter={StaticResource BoolToAlignment}}" Margin="3,5" VerticalAlignment="Bottom">
                                <Ellipse Width="35" Height="35" Margin="0,0,5,0" VerticalAlignment="Bottom" >
                                    <Ellipse.Fill>
                                        <Binding Path="Sender" Converter="{StaticResource SenderToColorConverter}" />
                                    </Ellipse.Fill>
                                    <Ellipse.IsVisible>
                                        <MultiBinding Converter="{StaticResource GroupAvatarVisibilityConverter}">
                                            <Binding Path="IsMine"/>
                                            <Binding Path="IsGroup"/>
                                        </MultiBinding>
                                    </Ellipse.IsVisible>
                                </Ellipse>
                                
                                <StackPanel>
                                    <TextBlock Text="{Binding Sender}" Margin="10,0,0,2">
                                        <TextBlock.IsVisible>
                                            <MultiBinding Converter="{StaticResource GroupSenderVisibilityConverter}">
                                                <Binding Path="IsMine"/>
                                                <Binding Path="IsGroup"/>
                                            </MultiBinding>
                                        </TextBlock.IsVisible>
                                    </TextBlock>
                                    
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Polygon Grid.Column="0" Width="10" Height="10" Points="10,0 -5,7 15,10" ZIndex="0" 
                                                 Fill="{Binding IsMine, Converter={StaticResource BoolToBrush}}"
                                                 VerticalAlignment="Bottom" Margin="0,0,-4,0" IsVisible="{Binding IsMine, Converter={StaticResource InverseBoolConverter}}">
                                        <Polygon.RenderTransform>
                                            <TranslateTransform Y="-1"/>
                                        </Polygon.RenderTransform>
                                        </Polygon>

                                        <Border Grid.Column="1" VerticalAlignment="Bottom" Background="{Binding IsMine, 
                                                Converter={StaticResource BoolToBrush}}" CornerRadius="10" Padding="10,5" ZIndex="1" MaxWidth="350">
                                            <TextBlock Text="{Binding DisplayText}" TextWrapping="Wrap"  LineHeight="20" >
                                                <TextBlock.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="Copy" Click="CopyMessage_Click"/>
                                                        <MenuItem Header="Delete">
                                                            <MenuItem Header="Delete for me" Click="DeleteMessageForMe_Click"/>
                                                            <MenuItem Header="Delete for everyone" Click="DeleteMessageForAll_Click"/>
                                                        </MenuItem>
                                                    </ContextMenu>
                                                </TextBlock.ContextMenu>
                                            </TextBlock>
                                        </Border>
                                        
                                        <Polygon Grid.Column="2" Width="10" Height="10" Points="-10,-5 14,7 -15,11" Margin="-4,0,0,0" 
                                                 ZIndex="0" Fill="{Binding IsMine, Converter={StaticResource BoolToBrush}}"
                                                 VerticalAlignment="Bottom" IsVisible="{Binding IsMine}">
                                        <Polygon.RenderTransform>
                                            <TranslateTransform Y="-1"/>
                                        </Polygon.RenderTransform>
                                        </Polygon>
                                    </Grid>
                                </StackPanel>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
            
            <Grid x:Name="MessageInputPanel" Grid.Row="2" IsVisible="False" Margin="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <TextBox x:Name="MessageTextBox" FontSize="18" Watermark="Type a message..." Padding="10,5,60,5" 
                         TextWrapping="Wrap" Text="{Binding ChatList.SelectedItem.Draft, Mode=TwoWay}" AcceptsReturn="True" 
                         VerticalContentAlignment="Center" MinHeight="50" MaxHeight="120" TextChanged="MessageTextBox_OnTextChanged"/>
                <Button Content="Send" Width="50" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0"
                        Click="SendMessage_Click"/>
            </Grid>
            
            <Border x:Name="SingleChatOverlay" Background="#1C1729" Grid.Row="1" Grid.RowSpan="2" IsVisible="False">
                <Grid Margin="30">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="23"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="50"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" x:Name="SearchUserBox" Watermark="Search for user..." FontSize="18" Padding="10" 
                                 HorizontalAlignment="Stretch" Background="#9183B0" Foreground="White" TextChanged="SearchUserBox_OnTextChanged"/>
                        <Button Grid.Column="1" x:Name="SearchButton" Content="S" FontSize="18" Margin="5,0,0,0" 
                                Foreground="White" HorizontalAlignment="Right" Click="SearchButton_Click"/>
                    </Grid>
                    
                    <TextBlock Grid.Row="1" x:Name="SearchErrorText" Text="" FontSize="14" Foreground="Red" Margin="10,7,0,0" IsVisible="False"/>
                    
                    <Border Grid.Row="2" x:Name="SearchResultBorder" Background="#3A2C4A" CornerRadius="10" Padding="10" Margin="0,10,0,0" IsVisible="False">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="10">
                            <Ellipse Width="45" Height="45" Fill="Gray"/>
                            <StackPanel Orientation="Vertical" VerticalAlignment="Center" Spacing="5">
                                <TextBlock x:Name="ResultUserName" Text="" FontSize="17" FontWeight="Bold" Foreground="White"/>
                                <TextBlock x:Name="ResultUserUsername" Text="" FontSize="14" Foreground="rgba(255,255,255,0.6)"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                   
                    <Button Grid.Row="4" Content="Start chat" x:Name="StartChatButton" Classes="submitBtn" Width="200" 
                            HorizontalAlignment="Center" FontSize="18" Click="StartChatButton_Click"/>
                </Grid>
            </Border>
            
            <Border x:Name="GroupChatOverlay" Background="#1C1729" Grid.Row="1" Grid.RowSpan="2" IsVisible="False">
                <Grid Margin="30,20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="23"/>
                        <RowDefinition Height="60"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="20"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="50"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0" x:Name="GroupSearchBox" Watermark="Search for user..." FontSize="18" Padding="10" 
                                 HorizontalAlignment="Stretch" Background="#9183B0" Foreground="White" />
                        <Button Grid.Column="1" x:Name="GroupSearchButton" Content="S" FontSize="18" Margin="5,0,0,0" 
                                Foreground="White" HorizontalAlignment="Right" Click="GroupSearchButton_Click"/>
                    </Grid>
                    
                    <TextBlock Grid.Row="1" x:Name="GroupSearchErrorText" Text="" FontSize="14" Foreground="Red" Margin="10,7,0,0" IsVisible="False"/>
                    
                    <Border Grid.Row="2" x:Name="GroupSearchResultBorder"
                            Background="#3A2C4A" CornerRadius="10" Padding="10" Margin="0,10,0,0"
                            IsVisible="False">
                        <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
                            <Ellipse Grid.Column="0" Width="40" Height="40" Fill="Gray" Margin="0,0,10,0"/>
                            <StackPanel Grid.Column="1" Orientation="Vertical">
                                <TextBlock x:Name="GroupResultName" FontSize="17" Foreground="White"/>
                                <TextBlock x:Name="GroupResultUsername" FontSize="14" Foreground="LightGray"/>
                            </StackPanel>
                            <Button Grid.Column="2" x:Name="AddMemberButton" Classes="nohover" VerticalAlignment="Center" Margin="5,0,0,0" Cursor="Hand" Click="AddMemberButton_Click">
                                <Image Source="avares://uchat/Resources/images/add.png" Width="30" Height="30"/>
                            </Button>
                        </Grid>
                    </Border>
                    
                    <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto">
                        <ListBox x:Name="SelectedMembersList" ItemsSource="{Binding SelectedGroupMembers}" Height="280"
                                 Background="#3A2C4A" CornerRadius="10" BorderBrush="Transparent" Margin="0,15,0,15">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <Ellipse Width="30" Height="30" Fill="Gray"/>
                                        <StackPanel Orientation="Vertical" Spacing="2" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Name}" FontSize="16" FontWeight="Bold" Foreground="White"/>
                                            <TextBlock Text="{Binding Username}" FontSize="14" Foreground="#CCCCCC"/>
                                        </StackPanel>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                    
                    <TextBox Grid.Row="4" x:Name="GroupNameBox" Watermark="Enter chat name" FontSize="18" Padding="10"
                             HorizontalAlignment="Stretch" Background="#9183B0" Foreground="White" TextChanged="GroupNameBox_OnTextChanged"/>
                    
                    <TextBlock Grid.Row="5" x:Name="GroupNameErrorText" Text="Name cannot be empty" FontSize="14" Foreground="Red" Margin="10,2,0,0" IsVisible="False"/>
                    
                    <Button Grid.Row="6" Content="Create group chat" x:Name="CreateGroupButton" Classes="submitBtn" Width="200" VerticalAlignment="Bottom"
                            HorizontalAlignment="Center" FontSize="18" Click="CreateGroupChat_Click"/>
                </Grid>
            </Border>
            
        </Grid>
    </Grid>
</UserControl>